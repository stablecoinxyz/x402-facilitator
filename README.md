# x402-facilitator

SBC x402 Facilitator - Verify and Settle Payments.

This implementation supports **v1** of the x402 protocol using **ERC-2612 Permit** signatures for gasless approval + settlement.

## Supported Networks

- **Base** (mainnet) — ERC-2612 Permit + TransferFrom
- **Solana** (mainnet) — Delegated SPL token transfer
- **Radius** (mainnet/testnet) — ERC-2612 Permit + TransferFrom
- **Base Sepolia** (testnet) — for development

## Installation

1. Clone the repository.
2. Install dependencies:
   ```bash
   npm install
   ```
3. Copy `.env.example` to `.env` and fill in your values:
   ```bash
   cp .env.example .env
   ```

## Usage

### Quick Demo

We have provided a complete demo environment using SBC tokens. The demo supports multiple networks via the `--network` flag.

**Available networks:**

| Network | Flag | Description |
|---------|------|-------------|
| `base` | `--network base` | Base Mainnet (default) |
| `base-sepolia` | `--network base-sepolia` | Base Sepolia Testnet |
| `radius` | `--network radius` | Radius Mainnet |
| `radius-testnet` | `--network radius-testnet` | Radius Testnet |

1.  **Setup the environment:**
    This script will generate EVM wallets for Client, Merchant, and Facilitator.
    It will check for:
    *   **ETH Balance (Gas):** Wallets need ETH for gas on the selected network.
    *   **SBC Balance (Payment):** Client needs SBC tokens.

    Once funded, it will approve the Facilitator to spend the Client's SBC tokens.
    ```bash
    npm run setup                            # defaults to Base Mainnet
    npm run setup -- --network base-sepolia  # use Base Sepolia testnet
    npm run setup -- --network radius        # use Radius Mainnet
    ```

2.  **Start the server** (Terminal 1):
    ```bash
    npm run dev
    ```

3.  **Run the demo client** (Terminal 2):
    ```bash
    npm run demo                            # defaults to Base Mainnet
    npm run demo -- --network base-sepolia  # must match the network used in setup
    ```

    The demo client signs an ERC-2612 Permit and sends a payment request to the facilitator. The facilitator then:
    1.  Verifies the permit signature and SBC balance.
    2.  Calls `permit()` on-chain to approve the transfer.
    3.  Calls `transferFrom()` to settle (SBC from Client to Merchant).
    4.  Returns the transaction hash.

### Configuration

Configuration is handled via `.env`. See `.env.example` for all available variables. A default `.env` is generated by `npm run setup`.

### Production

Build the project:
```bash
npm run build
```

Start the production server:
```bash
npm start
```

### Deployment (Fly.io)

```bash
fly deploy
```

### Testing

Run tests:
```bash
npm test
```
